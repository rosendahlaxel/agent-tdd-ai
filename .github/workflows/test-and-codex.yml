name: Tests and Codex Auto-Fix

on:
  workflow_dispatch:
    inputs:
      run_codex:
        description: "Set to true to run Codex auto-fix"
        required: false
        default: "false"

permissions:
  contents: write

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  test-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.12-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.12-

      - name: Detect Codex opt-in
        id: codex_opt
        run: |
          run_codex="${{ inputs.run_codex }}"
          if [ "${run_codex}" = "true" ]; then
            echo "run_codex=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_codex=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e '.[dev]'

      - name: Run tests (baseline)
        id: pytest
        timeout-minutes: 3
        run: |
          set -o pipefail
          pytest -q --maxfail=1 | tee /tmp/pytest.log
        continue-on-error: true

      - name: Codex auto-fix on failure
        id: codex
        timeout-minutes: 3
        if: steps.pytest.outcome == 'failure' && steps.codex_opt.outputs.run_codex == 'true' && env.OPENAI_API_KEY != ''
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/fix-tests.md
          output-file: codex-output.md
          sandbox: workspace-write
          model: gpt-5.1-codex-mini
          effort: low
          codex-args: --full-auto

      - name: Re-run tests after Codex fix
        id: pytest_after_codex
        timeout-minutes: 2
        if: steps.codex.outcome == 'success'
        run: |
          set -o pipefail
          pytest --last-failed --maxfail=1 -q | tee /tmp/pytest-after.log
        continue-on-error: true

      - name: Capture Codex patch
        if: steps.pytest.outcome == 'failure' || steps.codex.outcome == 'success'
        id: codex-patch
        run: |
          git diff --patch > codex-fix.patch
          if [ -s codex-fix.patch ]; then
            echo "file=codex-fix.patch" >> "$GITHUB_OUTPUT"
          else
            rm -f codex-fix.patch
          fi

      - name: Upload Codex patch artifact
        if: steps.codex-patch.outputs.file
        uses: actions/upload-artifact@v4
        with:
          name: codex-fix.patch
          path: ${{ steps.codex-patch.outputs.file }}

      - name: Upload Codex output
        if: steps.codex.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: codex-output
          path: codex-output.md

      - name: Commit Codex changes
        if: steps.codex.outcome == 'success' && steps.pytest_after_codex.outcome == 'success' && steps.codex_opt.outputs.run_codex == 'true' && github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet; then
            echo "No Codex changes to commit."
            exit 0
          fi
          # Avoid committing artifacts uploaded in prior steps.
          rm -f codex-fix.patch codex-output.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: apply Codex auto-fix"
          git push

      - name: Fail when tests still failing (no Codex run)
        if: steps.pytest.outcome == 'failure' && steps.codex_opt.outputs.run_codex != 'true'
        run: |
          echo "Tests failed and Codex auto-fix was not requested (set run_codex=true when dispatching the workflow)." >&2
          exit 1

      - name: Fail when Codex auto-fix is skipped (missing API key)
        if: steps.pytest.outcome == 'failure' && steps.codex_opt.outputs.run_codex == 'true' && env.OPENAI_API_KEY == ''
        run: |
          echo "Tests failed but Codex auto-fix did not run (API key missing)." >&2
          exit 1

      - name: Fail when tests still failing after Codex
        if: steps.codex.outcome == 'success' && steps.pytest_after_codex.outcome != 'success'
        run: |
          echo "Tests are still failing after Codex auto-fix." >&2
          exit 1
